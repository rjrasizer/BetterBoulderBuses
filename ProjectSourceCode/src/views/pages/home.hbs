<!-- Full-page Mapbox map for Better Boulder Buses -->
<style>
  /* Hide the global footer on the map page to avoid overlaying the map */
  footer {
    display: none;
  }

  html,
  body {
    height: 100%;
    margin: 0;
  }

  /* Ensure the map fills the visible page area */
  #map {
    position: fixed;
    /* Fully cover the viewport regardless of page flow */
    inset: 0;
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    /* fallback background before tiles load */
  }

  /* Optional: a small overlay to verify the page loaded */
  .overlay {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 1;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 14px;
    color: #333;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
  }

  .overlay .status-ok {
    color: #198754;
  }

  .overlay .status-warn {
    color: #dc3545;
  }

  .overlay .status-info {
    color: #0d6efd;
  }
</style>

<!-- Mapbox GL JS CSS is included in main layout head -->

<div class="overlay">
  <strong>Better Boulder Buses</strong>
  <span> — Map status:
    {{#if mapboxToken}}<span id="map-status" class="status-ok">token set</span>{{else}}<span id="map-status"
      class="status-warn">missing token</span>{{/if}}
  </span>
  {{#if title}}<div>{{title}}</div>{{/if}}
  <div style="font-size: 12px; color: #666;">/home</div>
  <div id="diag" style="font-size:12px;color:#666;max-width:320px;word-break:break-all"></div>
</div>

<div id="map" role="region" aria-label="Interactive transit map"></div>

<!-- Add this inside your main layout (index.hbs) body, near the top -->
<a href="/settings" 
   class="position-fixed top-0 end-0 m-3 text-dark">
  <i class="bi bi-gear-fill fs-3"></i>
</a>

<!-- Mapbox GL JS script -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>

<script>
  (function () {
    // Token passed from server via template
    var tokenFromServer = '{{mapboxToken}}';

    if (!tokenFromServer || tokenFromServer === '' || tokenFromServer === 'undefined') {
      console.error('Mapbox access token is missing. Set MAPBOX_ACCESS_TOKEN in your .env and restart.');
      return;
    }

    function setStatus(text, cls) {
      var s = document.getElementById('map-status');
      if (s) { s.className = cls || 'status-info'; s.textContent = text; }
      var d = document.getElementById('diag');
      if (d) d.textContent = text;
    }

    function loadScript(src) {
      return new Promise(function (resolve, reject) {
        var s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = function (e) { reject(new Error('Failed to load ' + src)); };
        document.head.appendChild(s);
      });
    }

    function loadCSS(href) {
      return new Promise(function (resolve, reject) {
        var l = document.createElement('link');
        l.rel = 'stylesheet';
        l.href = href;
        l.onload = resolve;
        l.onerror = function () { reject(new Error('Failed to load ' + href)); };
        document.head.appendChild(l);
      });
    }

    function initMapbox() {
      if (typeof mapboxgl === 'undefined') {
        console.warn('mapboxgl undefined before init; attempting alternate CDN...');
        // Try alternate CDN (unpkg) with a known version
        return Promise.all([
          loadCSS('https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.css'),
          loadScript('https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js')
        ])
          .then(function () {
            if (typeof mapboxgl === 'undefined') throw new Error('mapboxgl still undefined after alternate CDN');
            return createMapboxMap();
          })
          .catch(function (err) {
            console.error(err);
            setStatus('Mapbox GL JS failed (blockers?). Falling back to MapLibre…', 'status-warn');
            return initMapLibre();
          });
      }
      return createMapboxMap();
    }

    function createMapboxMap() {
      mapboxgl.accessToken = tokenFromServer;
      if (!mapboxgl.supported()) {
        console.error('WebGL not supported in this browser/device.');
        setStatus('WebGL not supported. Enable hardware acceleration or try another browser.', 'status-warn');
        return;
      }
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-105.2705, 40.0150],
        zoom: 12
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', function () {
        setStatus('loaded', 'status-info');

        // Waypoints (lng,lat) the route should connect along streets
        var waypoints = [
          [-105.2760, 40.0190],
          [-105.2730, 40.0145],
          [-105.2705, 40.0120],
          [-105.2650, 40.0090],
          [-105.2610, 40.0060]
        ];

        // Visualize stops (pins) regardless of routing
        var stopsGeoJSON = {
          type: 'FeatureCollection',
          features: [
            { type: 'Feature', properties: { name: 'Stop A' }, geometry: { type: 'Point', coordinates: waypoints[0] } },
            { type: 'Feature', properties: { name: 'Stop B' }, geometry: { type: 'Point', coordinates: waypoints[2] } },
            { type: 'Feature', properties: { name: 'Stop C' }, geometry: { type: 'Point', coordinates: waypoints[4] } }
          ]
        };
        if (!map.getSource('demo-stops')) {
          map.addSource('demo-stops', { type: 'geojson', data: stopsGeoJSON });
        } else {
          map.getSource('demo-stops').setData(stopsGeoJSON);
        }
        if (!map.getLayer('demo-stops-circles')) {
          map.addLayer({ id: 'demo-stops-circles', type: 'circle', source: 'demo-stops', paint: { 'circle-radius': 5, 'circle-color': '#ef4444', 'circle-stroke-color': '#ffffff', 'circle-stroke-width': 1 } });
        }
        if (!map.getLayer('demo-stops-labels')) {
          map.addLayer({ id: 'demo-stops-labels', type: 'symbol', source: 'demo-stops', layout: { 'text-field': ['get', 'name'], 'text-size': 12, 'text-offset': [0, 1.2], 'text-anchor': 'top' }, paint: { 'text-color': '#111827' } });
        }

        // Request a street-following route from Mapbox Directions API
        var coordsParam = waypoints.map(function (c) { return c[0] + ',' + c[1]; }).join(';');
        var url = 'https://api.mapbox.com/directions/v5/mapbox/driving/' + coordsParam + '?geometries=geojson&overview=full&access_token=' + encodeURIComponent(mapboxgl.accessToken);

        fetch(url)
          .then(function (r) { if (!r.ok) throw new Error('Directions request failed: ' + r.status); return r.json(); })
          .then(function (json) {
            if (!json.routes || !json.routes[0]) throw new Error('No route found');
            var line = json.routes[0].geometry; // GeoJSON LineString

            // Add/update route source and layer
            var routeFC = { type: 'FeatureCollection', features: [{ type: 'Feature', properties: { name: 'Routed' }, geometry: line }] };
            if (!map.getSource('demo-route')) {
              map.addSource('demo-route', { type: 'geojson', data: routeFC });
            } else {
              map.getSource('demo-route').setData(routeFC);
            }
            if (!map.getLayer('demo-route-line')) {
              map.addLayer({ id: 'demo-route-line', type: 'line', source: 'demo-route', paint: { 'line-color': '#2563eb', 'line-width': 4 } });
            }

            // Fit to route
            try {
              var Bounds = (mapboxgl && mapboxgl.LngLatBounds);
              var b = new Bounds();
              line.coordinates.forEach(function (c) { b.extend(c); });
              map.fitBounds(b, { padding: 50, duration: 0 });
            } catch (e) { console.warn('Could not fit bounds:', e); }

            // Animate a fake bus along the route
            animateBus(map, line.coordinates);
          })
          .catch(function (err) {
            console.error(err);
            setStatus('Routing failed, showing straight line', 'status-warn');
            // Fallback: draw straight line through waypoints
            var straight = { type: 'FeatureCollection', features: [{ type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: waypoints } }] };
            if (!map.getSource('demo-route')) map.addSource('demo-route', { type: 'geojson', data: straight }); else map.getSource('demo-route').setData(straight);
            if (!map.getLayer('demo-route-line')) map.addLayer({ id: 'demo-route-line', type: 'line', source: 'demo-route', paint: { 'line-color': '#2563eb', 'line-width': 4 } });
            animateBus(map, waypoints);
          });

        function animateBus(map, pathCoords) {
          // Create a simple bus marker
          var el = document.createElement('div');
          el.style.width = '20px';
          el.style.height = '20px';
          el.style.background = '#10b981';
          el.style.border = '2px solid white';
          el.style.borderRadius = '50%';
          el.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';
          el.title = 'Bus';
          var marker = new mapboxgl.Marker({ element: el }).setLngLat(pathCoords[0]).addTo(map);

          var segIndex = 0; // which segment
          var t = 0;        // 0..1 along segment
          var speed = 0.01; // tune for speed (~meters per frame proxy)

          function lerp(a, b, t) { return [a[0] + (b[0] - a[0]) * t, a[1] + (b[1] - a[1]) * t]; }
          function animate() {
            var a = pathCoords[segIndex];
            var b = pathCoords[segIndex + 1];
            if (!b) { segIndex = 0; t = 0; a = pathCoords[0]; b = pathCoords[1]; }
            t += speed;
            if (t >= 1) { t = 0; segIndex++; }
            var p = lerp(a, b, t);
            marker.setLngLat(p);
            requestAnimationFrame(animate);
          }
          requestAnimationFrame(animate);
        }
      });
      map.on('error', function (e) {
        console.error('Mapbox GL error:', e && e.error ? e.error : e);
        setStatus('Map error: ' + (e && e.error && e.error.message ? e.error.message : 'see console'), 'status-warn');
      });
    }

    function initMapLibre() {
      // Load MapLibre JS and CSS and render a demo style as a fallback
      return loadCSS('https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css')
        .then(function () { return loadScript('https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'); })
        .then(function () {
          if (typeof maplibregl === 'undefined') throw new Error('maplibregl undefined');
          var map = new maplibregl.Map({
            container: 'map',
            style: 'https://demotiles.maplibre.org/style.json',
            center: [-105.2705, 40.0150],
            zoom: 12
          });
          map.addControl(new maplibregl.NavigationControl(), 'top-right');
          map.on('load', function () {
            setStatus('fallback loaded (MapLibre)', 'status-info');

            // --- Demo (MapLibre fallback): route + stops ---
            var routeGeoJSON = {
              type: 'FeatureCollection',
              features: [
                {
                  type: 'Feature',
                  properties: { name: 'Test Route' },
                  geometry: {
                    type: 'LineString',
                    coordinates: [
                      [-105.2760, 40.0190],
                      [-105.2730, 40.0145],
                      [-105.2705, 40.0120],
                      [-105.2650, 40.0090],
                      [-105.2610, 40.0060]
                    ]
                  }
                }
              ]
            };
            var stopsGeoJSON = {
              type: 'FeatureCollection',
              features: [
                { type: 'Feature', properties: { name: 'Stop A' }, geometry: { type: 'Point', coordinates: [-105.2760, 40.0190] } },
                { type: 'Feature', properties: { name: 'Stop B' }, geometry: { type: 'Point', coordinates: [-105.2705, 40.0120] } },
                { type: 'Feature', properties: { name: 'Stop C' }, geometry: { type: 'Point', coordinates: [-105.2610, 40.0060] } }
              ]
            };
            if (!map.getSource('demo-route')) {
              map.addSource('demo-route', { type: 'geojson', data: routeGeoJSON });
            }
            if (!map.getLayer('demo-route-line')) {
              map.addLayer({ id: 'demo-route-line', type: 'line', source: 'demo-route', paint: { 'line-color': '#3b82f6', 'line-width': 4 } });
            }
            if (!map.getSource('demo-stops')) {
              map.addSource('demo-stops', { type: 'geojson', data: stopsGeoJSON });
            }
            if (!map.getLayer('demo-stops-circles')) {
              map.addLayer({ id: 'demo-stops-circles', type: 'circle', source: 'demo-stops', paint: { 'circle-radius': 5, 'circle-color': '#ef4444', 'circle-stroke-color': '#ffffff', 'circle-stroke-width': 1 } });
            }
            if (!map.getLayer('demo-stops-labels')) {
              map.addLayer({ id: 'demo-stops-labels', type: 'symbol', source: 'demo-stops', layout: { 'text-field': ['get', 'name'], 'text-size': 12, 'text-offset': [0, 1.2], 'text-anchor': 'top' }, paint: { 'text-color': '#111827' } });
            }
            try {
              var Bounds = (window.mapboxgl && mapboxgl.LngLatBounds) || (window.maplibregl && maplibregl.LngLatBounds);
              var b = new Bounds();
              routeGeoJSON.features[0].geometry.coordinates.forEach(function (c) { b.extend(c); });
              map.fitBounds(b, { padding: 40, duration: 0 });
            } catch (e) { console.warn('Could not fit bounds:', e); }
            // --- End demo ---
          });
          map.on('error', function (e) { console.error('MapLibre error:', e); setStatus('MapLibre error: see console', 'status-warn'); });
        })
        .catch(function (e) { console.error(e); setStatus('Fallback failed to load. See console.', 'status-warn'); });
    }

    function start() {
      if (!tokenFromServer || tokenFromServer === '' || tokenFromServer === 'undefined') {
        console.error('Mapbox access token is missing. Set MAPBOX_ACCESS_TOKEN in your .env and restart.');
        return;
      }
      initMapbox();
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      start();
    } else {
      window.addEventListener('DOMContentLoaded', start);
    }
  })();
</script>